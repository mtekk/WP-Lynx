var llynx=llynx||{};(function(e){llynx.ajaxurl=ajaxurl;llynx.l10n=llynx_l10n;llynx.send_to_editor=function(h){var i,j,g=typeof tinymce!=="undefined";if(g){i=tinymce.get(wpActiveEditor);if(j=i.dom.getParent(i.selection.getNode(),"div.llynx_print")){e(j).after(h);return 0}}window.send_to_editor(h)};var d=Backbone.Model.extend({urlRoot:"/wplynx",defaults:{url:"",title:"",descriptions:"",description:0,images:"",image:0},sync:function(){return false}});var c=Backbone.Collection.extend({model:d});llynx.sites=new c();var a=Backbone.Model.extend({urlRoot:"/wplynx",defaults:{type:"",message:""},sync:function(){return false}});var b=Backbone.Collection.extend({model:a});llynx.messages=new b();var f;llynx.media=f={};_.extend(f,{view:{},controller:{}});llynx.view={};llynx.view.lynxPrint=Backbone.View.extend({className:"llynx-print",template:_.template(e("#tmpl-llynx-print").html()),events:{"click .llynx_img_prev":"prevImg","click .llynx_img_next":"nextImg","click .llynx_desc_prev":"prevDesc","click .llynx_desc_next":"nextDesc","click .llynx_del":"del","click .llynx_insert":"insertPre","change input":"changeTitle","keyup textarea":"keyupDescription"},initialize:function(){this.listenTo(this.model,"change",this.render);this.listenTo(this.model,"destroy",this.remove);_.bindAll(this,"render","nextImg","prevImg","sendToPost","del","keyupDescription")},render:function(){this.$el.html(this.template(this.model.attributes));return this},nextImg:function(){curImage=this.model.attributes.image;if(++curImage<this.model.attributes.images.length){this.model.set({image:curImage})}},prevImg:function(){curImage=this.model.attributes.image;if(--curImage>=0){this.model.set({image:curImage})}},nextDesc:function(){curDesc=this.model.attributes.description;if(++curDesc<this.model.attributes.descriptions.length){this.model.set({description:curDesc})}},prevDesc:function(){curDesc=this.model.attributes.description;if(--curDesc>=0){this.model.set({description:curDesc})}},del:function(){this.model.destroy()},insertPre:function(){e(".spinner",this.$el).show();e.post(llynx.ajaxurl,{action:"wp_lynx_fetch_print",title:this.model.attributes.title,url:this.model.attributes.url,image:this.model.attributes.images[this.model.attributes.image],description:this.model.attributes.descriptions[this.model.attributes.description],nonce:"1234"},this.sendToPost,"html")},sendToPost:function(g){var h=g;llynx.send_to_editor(h);llynx.messages.create({type:"notice",message:llynx.l10n.insertSuccessMsg});this.del()},changeTitle:function(h){var g=h.target.value.trim();this.model.set({title:g})},keyupDescription:function(g){var h=this.model.attributes.descriptions;h[this.model.attributes.description]=g.target.value.trim();this.model.set({descriptions:h})}});llynx.view.message=Backbone.View.extend({className:"llynx-message",template:_.template(e("#tmpl-llynx-message").html()),events:{"click .llynx_message_close":"del"},initialize:function(){this.listenTo(this.model,"change",this.render);this.listenTo(this.model,"destroy",this.remove);_.bindAll(this,"render","del")},render:function(){this.$el.html(this.template(this.model.attributes));return this},del:function(){this.model.destroy()}});llynx.media.view.llynxPrintInsert=Backbone.View.extend({className:"llynx-print-insert-toolbar",template:_.template(e("#tmpl-llynx-print-insert").html()),initialize:function(){this.listenTo(llynx.sites,"all",this.render);this.listenTo(llynx.media._frame.states,"activate",this.render);_.bindAll(this,"render","insertPrints")},events:{"click .llynx-print-insert-all":"insertPrints"},insertPre:function(g){e.post(llynx.ajaxurl,{action:"wp_lynx_fetch_print",title:g.attributes.title,url:g.attributes.url,image:g.attributes.images[g.attributes.image],description:g.attributes.descriptions[g.attributes.description],nonce:"1234"},this.sendToPost,"html")},sendToPost:function(g){var h=g;llynx.send_to_editor(h)},insertPrints:function(g){if(e(g.target).attr("disabled")!=undefined){return 0}llynx.sites.each(this.insertPre,this);_.invoke(llynx.sites.toArray(),"destroy");llynx.media._frame.close()},render:function(){var g;if(llynx.media._frame._state=="llynx-print-add-state"){g=llynx.sites.length}else{g=0}this.$el.html(this.template({length:g}));return this}});f.view.llynxPrintAdd=Backbone.View.extend({className:"llynx-print-add-frame",template:_.template(e("#tmpl-llynx-print-add").html()),initialize:function(){this.listenTo(llynx.sites,"reset",this.addAll);this.listenTo(llynx.sites,"add",this.addSite);this.listenTo(llynx.messages,"add",this.addMessage);_.bindAll(this,"keyup","save","response","addSite","addMessage","addAll")},events:{"keyup #llynx_url":"keyup"},keyup:function(g){if(g.keyCode===13){this.save(g)}},save:function(g){e(".embed-url .spinner").show();_.invoke(llynx.messages.toArray(),"destroy");e.post(llynx.ajaxurl,{action:"wp_lynx_fetch_url",url:e("input[name=llynx_url]").val(),nonce:"1234"},this.response,"json")},response:function(g){e(".embed-url .spinner").hide();if(g.hasOwnProperty("error")){console.log(g.error_msg);llynx.messages.create({type:"error",message:g.error_msg})}else{llynx.sites.create({url:g.url,title:g.title,descriptions:g.descriptions,images:g.images})}},addSite:function(h){var g=new llynx.view.lynxPrint({model:h});this.$("#llynx_sites").append(g.render().el);this.$("input[name=llynx_url]").val("")},addMessage:function(h){var g=new llynx.view.message({model:h});this.$("#llynx_sites").append(g.render().el);this.$("input[name=llynx_url]").val("")},addAll:function(){this.$("#llynx_sites").html("");llynx.sites.each(this.addSite,this);llynx.messages.each(this.addMessage,this)},render:function(){this.$el.html(this.template({}));this.addAll();return this}});f.controller.llynxPrintAdd=wp.media.controller.State.extend({defaults:{id:"llynx-print-add-state",menu:"default",content:"llynx_print_add_state"}});f.view.llynxHelp=wp.media.View.extend({className:"llynx-help-frame",template:wp.media.template("llynx-help")});f.controller.llynxHelp=wp.media.controller.State.extend({defaults:{id:"llynx-help-state",menu:"default",content:"llynx_help_state"}});f.buttonId="#add_link_print",_.extend(f,{frame:function(){if(this._frame){return this._frame}var g=[new f.controller.llynxPrintAdd({title:"Add Lynx Print",id:"llynx-print-add-state",priority:10,toolbar:"llynx_print_insert"}),new f.controller.llynxHelp({title:"Help",id:"llynx-help-state",priority:20})];this._frame=wp.media({className:"media-frame no-sidebar",state:"llynx-print-add-state",states:g});this._frame.on("content:create:llynx_print_add_state",function(){var h=new llynx.media.view.llynxPrintAdd({controller:f.frame(),model:f.frame().state()});var i=new llynx.media.view.llynxPrintInsert({controller:f.frame(),model:f.frame().state()});f.frame().content.set(h);f.frame().toolbar.set(i)});this._frame.on("content:create:llynx_help_state",function(){var h=new llynx.media.view.llynxHelp({controller:f.frame(),model:f.frame().state()});f.frame().content.set(h)});this._frame.on("open",this.open);this._frame.on("ready",this.ready);this._frame.on("close",this.close);this._frame.on("menu:render:default",this.menuRender);return this._frame},open:function(){e(".media-modal").addClass("smaller")},events:{},ready:function(){},close:function(){e(".media-modal").removeClass("smaller")},menuRender:function(g){},init:function(){e(f.buttonId).on("click",function(g){g.preventDefault();f.frame().open()})}});e(f.init)})(jQuery);